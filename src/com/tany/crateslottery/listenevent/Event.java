package com.tany.crateslottery.listenevent;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.configuration.file.YamlConfiguration;
import org.bukkit.conversations.Conversation;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.block.Action;
import org.bukkit.event.block.BlockBreakEvent;
import org.bukkit.event.block.BlockPlaceEvent;
import org.bukkit.event.entity.PlayerDeathEvent;
import org.bukkit.event.inventory.InventoryClickEvent;
import org.bukkit.event.inventory.InventoryCloseEvent;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.event.player.PlayerToggleSneakEvent;
import org.bukkit.inventory.Inventory;
import org.bukkit.inventory.ItemStack;
import org.bukkit.plugin.Plugin;
import org.bukkit.potion.PotionEffect;
import org.bukkit.potion.PotionEffectType;

import com.comphenix.protocol.utility.StreamSerializer;
import com.tany.crateslottery.Main;
import com.tany.crateslottery.conversation.Name;
import com.tany.crateslottery.gui.Gui;
import com.tany.crateslottery.task.NineWingTask;
import com.tany.crateslottery.task.NineWingTaskS;
import com.tany.crateslottery.task.WingTask;
import com.tany.crateslottery.task.WingTaskS;

import net.minecraft.server.v1_12_R1.MobEffects;

public class Event implements Listener  {
	public static String crate = null;
    HashMap<Player, Boolean> Sneak = new HashMap<Player, Boolean>();
    Plugin config = Bukkit.getPluginManager().getPlugin("CratesLottery");
    File file=new File(config.getDataFolder(),"config.yml");
    File file1=new File(config.getDataFolder(),"data.yml");
    File file2=new File(config.getDataFolder(),"message.yml");
    
    @EventHandler
	public void Toggle(PlayerToggleSneakEvent event) {
	    FileConfiguration config1=YamlConfiguration.loadConfiguration(file);
	    FileConfiguration config2=YamlConfiguration.loadConfiguration(file1);
	    FileConfiguration config3=YamlConfiguration.loadConfiguration(file2);
		if(event.isSneaking()) {
			Sneak.put(event.getPlayer(), true);
		}else {
			Sneak.put(event.getPlayer(), false);
		}
	}

	@EventHandler
    public void Break(BlockBreakEvent event) {
        FileConfiguration config1=YamlConfiguration.loadConfiguration(file);
        FileConfiguration config2=YamlConfiguration.loadConfiguration(file1);
        FileConfiguration config3=YamlConfiguration.loadConfiguration(file2);
        List<String> Location = config2.getStringList("Location");
        Location block = event.getBlock().getLocation();
        if(Location.size()!=0) {
        	for(String location:Location) {
				String world = location.split(":")[0];
				int x = Integer.parseInt(location.split(":")[1]);
				int y = Integer.parseInt(location.split(":")[2]);
				int z = Integer.parseInt(location.split(":")[3]);
				if(block.getBlockX()==x&&block.getBlockY()==y&&block.getBlockZ()==z&&block.getWorld().equals(Bukkit.getWorld(world))) {
					if(event.getPlayer().isOp()) {
						if(Sneak.containsKey(event.getPlayer())&&Sneak.get(event.getPlayer())) {
							event.getPlayer().sendMessage("¡ìa³É¹¦ÆÆ»µ³é½±Ïä£¡");
							Location.remove(location);
							config2.set("Location", Location);
					  		try {
					  			config2.save(file1);
					  		} catch (IOException e) {
					  			e.printStackTrace();
				        	}
						}
					}else {
						event.setCancelled(true);
						event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("BreakCrateMessage")));
					}
					return;
				}
        	}
        }
    }
    
    @EventHandler
	public void onInteract(PlayerInteractEvent event) {
	    FileConfiguration config1=YamlConfiguration.loadConfiguration(file);
	    FileConfiguration config2=YamlConfiguration.loadConfiguration(file1);
	    FileConfiguration config3=YamlConfiguration.loadConfiguration(file2);
		Action action=event.getAction();
		if((event.getItem()!=null&&event.getItem().getItemMeta().hasDisplayName()&&event.getItem().getItemMeta().getDisplayName().startsWith("¡ìa¿ªÏä¡ì6Ô¿³×¡ì3£º"))) {
			event.setCancelled(true);
			String name = ChatColor.stripColor(event.getItem().getItemMeta().getDisplayName().replace("¡ìa¿ªÏä¡ì6Ô¿³×¡ì3£º", ""));
			if(config2.getString("Info."+name+".color")==null) {
				event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("ClearKeyMessage")));
				event.getPlayer().getInventory().setItemInHand(null);
	    		return;
			}
			if(action.equals(action.RIGHT_CLICK_AIR)) {
				event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("UseKeyMessage")));
				return;
			}
		}
		if(event.getItem()!=null&&event.getItem().getItemMeta().hasDisplayName()&&!event.getItem().getItemMeta().getDisplayName().equals("¡ìaÏä¡ì2×Ó¡ì5£º")&&event.getItem().getItemMeta().getDisplayName().startsWith("¡ìaÏä¡ì2×Ó¡ì5£º")) {
			String name = ChatColor.stripColor(event.getItem().getItemMeta().getDisplayName().replace("¡ìaÏä¡ì2×Ó¡ì5£º", ""));
			if(config2.getString("Info."+name+".color")==null) {
				event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("ClearCrateMessage")));
				event.getPlayer().getInventory().setItemInHand(null);
			}
			return;
		}
		if(event.getClickedBlock()!=null&&action.equals(action.RIGHT_CLICK_BLOCK)) {
	    	List<String> Location = config2.getStringList("Location");
	    	Location block = event.getClickedBlock().getLocation();
	    	if(Location.size()!=0) {
	    		for(String location:Location) {
	    			String world = location.split(":")[0];
	    			int x = Integer.parseInt(location.split(":")[1]);
	    			int y = Integer.parseInt(location.split(":")[2]);
	    			int z = Integer.parseInt(location.split(":")[3]);
	    			String name = location.split(":")[4];
	    			if(block.getBlockX()==x&&block.getBlockY()==y&&block.getBlockZ()==z&&block.getWorld().equals(Bukkit.getWorld(world))) {
	    				event.setCancelled(true);
	        			if(config2.getString("Info."+name+".color")==null) {
	        				event.getClickedBlock().setType(Material.AIR);
	        				event.setCancelled(true);
	        				event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("ClearCrateMessage")));
							Location.remove(location);
							config2.set("Location", Location);
					  		try {
					  			config2.save(file1);
					  		} catch (IOException e) {
					  			e.printStackTrace();
				        	}
	        				return;
	        			}
						String version = Bukkit.getServer().getVersion();
						if(version.contains("1.9")||version.contains("1.10")||version.contains("1.11")||version.contains("1.12")||version.contains("1.13")||version.contains("1.14")||version.contains("1.15")) {
							if(event.getPlayer().getInventory().getItemInHand()==null||event.getPlayer().getInventory().getItemInHand().getType()==Material.AIR) {
								event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("NoOpenCrateMessage").replace("[key]", config2.getString("Info."+name+".color")+name)));
								return;
							}else if(!event.getPlayer().getInventory().getItemInHand().getItemMeta().hasDisplayName()) {
								event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("NoOpenCrateMessage").replace("[key]", config2.getString("Info."+name+".color")+name)));
								return;
							}else if(!ChatColor.stripColor(event.getPlayer().getInventory().getItemInHand().getItemMeta().getDisplayName().replace("¡ìa¿ªÏä¡ì6Ô¿³×¡ì3£º", "")).equals(name)) {
								event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("NoOpenCrateMessage").replace("[key]", config2.getString("Info."+name+".color")+name)));
								return;
							}
						}else {
							if(event.getPlayer().getInventory().getItemInHand()==null||event.getPlayer().getInventory().getItemInHand().getType()==Material.AIR) {
								event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("NoOpenCrateMessage").replace("[key]", config2.getString("Info."+name+".color")+name)));
								return;
							}else if(!event.getPlayer().getInventory().getItemInHand().getItemMeta().hasDisplayName()) {
								event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("NoOpenCrateMessage").replace("[key]", config2.getString("Info."+name+".color")+name)));
								return;
							}else if(!ChatColor.stripColor(event.getPlayer().getInventory().getItemInHand().getItemMeta().getDisplayName().replace("¡ìa¿ªÏä¡ì6Ô¿³×¡ì3£º", "")).equals(name)) {
								event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("NoOpenCrateMessage").replace("[key]", config2.getString("Info."+name+".color")+name)));
								return;
							}
						}
	    				if(Sneak.containsKey(event.getPlayer())&&Sneak.get(event.getPlayer())) {
	    					if(!event.getPlayer().hasPermission("cl.ninelottery")) {
	    						event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("NoNineLotteryMessage")));
	    						return;
	    					}
	    					if(config2.getBoolean("Info."+name+".clear")) {
	    						event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("ClearMessage")));
	    						return;
	    					}
	        					List<String> itemlist = config2.getStringList("Info."+name+".data");
	        					int a=1;
	        					for(String item:itemlist) {
	        						if(!item.split(":")[1].equals("null")) {
	        							break;
	        						}
	        						if(a==itemlist.size()) {
	        							event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("NoItemMessage")));
	        							return;
	        						}
	        						a++;
	        					}
	            					if(event.getItem().getAmount()<9) {
	            						event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("NoNineKeyMessage")));
	            						return;
	            					}
	            					int amount = event.getItem().getAmount();
	            					amount=amount-9;
	            	    			if(version.contains("1.9")||version.contains("1.10")||version.contains("1.11")||version.contains("1.12")||version.contains("1.13")||version.contains("1.14")||version.contains("1.15")) {
	                	    			if(amount!=0)
	            	    				event.getPlayer().getInventory().getItemInHand().setAmount(amount);
	                	    			else
	                	    			event.getPlayer().getInventory().setItemInHand(null);
	            	    			}else {
	            	    				if(amount!=0)
	                	    			event.getPlayer().getInventory().getItemInHand().setAmount(amount);
	                	    			else
	      								event.getPlayer().getInventory().setItemInHand(null);
	            	    			}
	            	    			if(!config2.getString("Info."+name+".nine").equals("ÎÞ"))
	            	    				Bukkit.broadcastMessage(ChatColor.translateAlternateColorCodes('&', config2.getString("Info."+name+".nine").replace("[player]", event.getPlayer().getName())));
	            	    			event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("NineOpenCrateMessage").replace("[crate]", config2.getString("Info."+name+".color")+name)));
	            					if(config2.getBoolean("Info."+name+".nineanimation")) {
	            						if(config2.getDouble("Info."+name+".ninecd")<=0&&config2.getDouble("Info."+name+".ninenumber")<=0)
	            						new NineWingTask(event.getPlayer(), name,config1.getInt("NineWingLongTime")).runTaskTimer(Main.plugin, 0, (int) (config1.getDouble("NineWingSpaceTime")*20));
	            						else
	            						new NineWingTask(event.getPlayer(), name,config2.getInt("Info."+name+".ninenumber")).runTaskTimer(Main.plugin, 0, (int) (config2.getDouble("Info."+name+".ninecd")*20));
	            					}else {
	            						new NineWingTaskS(event.getPlayer(), name).runTaskTimer(Main.plugin, 0, 0);
	            					}
	                				return;
	    				}else {
	    					if(!event.getPlayer().hasPermission("cl.lottery")) {
	    						event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("NoLotteryMessage")));
	    						return;
	    					}
	    					List<String> itemlist = config2.getStringList("Info."+name+".data");
	    					int a=1;
	    					for(String item:itemlist) {
	    						if(!item.split(":")[1].equals("null")) {
	    							break;
	    						}
	    						if(a==itemlist.size()) {
	    							event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("NoItemMessage")));
	    							return;
	    						}
	    						a++;
	    					}
	    					int amount = event.getItem().getAmount();
	    					amount--;
	    	    			if(version.contains("1.9")||version.contains("1.10")||version.contains("1.11")||version.contains("1.12")||version.contains("1.13")||version.contains("1.14")||version.contains("1.15")) {
	        	    			if(amount!=0)
	    	    				event.getPlayer().getInventory().getItemInHand().setAmount(amount);
	        	    			else
	        	    			event.getPlayer().getInventory().setItemInHand(null);
	    	    			}else {
	    	    				if(amount!=0)
	        	    			event.getPlayer().getInventory().getItemInHand().setAmount(amount);
	        	    			else
								event.getPlayer().getInventory().setItemInHand(null);
	    	    			}
	    	    			if(!config2.getString("Info."+name+".announcement").equals("ÎÞ"))
	    	    				Bukkit.broadcastMessage(ChatColor.translateAlternateColorCodes('&', config2.getString("Info."+name+".announcement").replace("[player]", event.getPlayer().getName())));
	    	    			event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("OpenCrateMessage").replace("[crate]", config2.getString("Info."+name+".color")+name)));
	    					if(config2.getBoolean("Info."+name+".animation")) {
	    						if(config2.getDouble("Info."+name+".cd")<=0&&config2.getDouble("Info."+name+".number")<=0)
	    						new WingTask(event.getPlayer(), name, config1.getInt("WingLongTime")).runTaskTimer(Main.plugin, 0, (int) (config1.getDouble("WingSpaceTime")*20));
	    						else
	    						new WingTask(event.getPlayer(), name, config2.getInt("Info."+name+".number")).runTaskTimer(Main.plugin, 0, (int) (config2.getDouble("Info."+name+".cd")*20));
	    					}else {
	    						new WingTaskS(event.getPlayer(), name).runTaskTimer(Main.plugin, 0, 0);
	    					}
	        				return;
	        			}
	    			}
	    		}
	    	}
		}
		if(action.equals(Action.LEFT_CLICK_BLOCK)&&!(Sneak.containsKey(event.getPlayer())&&Sneak.get(event.getPlayer()))) {
	    	List<String> Location = config2.getStringList("Location");
	    	Location block = event.getClickedBlock().getLocation();
	    	if(Location.size()!=0) {
	    		for(String location:Location) {
	    			String world = location.split(":")[0];
	    			int x = Integer.parseInt(location.split(":")[1]);
	    			int y = Integer.parseInt(location.split(":")[2]);
	    			int z = Integer.parseInt(location.split(":")[3]);
	    			String name = location.split(":")[4];
	    			if(block.getBlockX()==x&&block.getBlockY()==y&&block.getBlockZ()==z&&block.getWorld().equals(Bukkit.getWorld(world))) {
	        			if(config2.getString("Info."+name+".color")==null) {
	        				event.getClickedBlock().setType(Material.AIR);
	        				event.setCancelled(true);
	        				event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("ClearCrateMessage")));
							Location.remove(location);
							config2.set("Location", Location);
					  		try {
					  			config2.save(file1);
					  		} catch (IOException e) {
					  			e.printStackTrace();
				        	}
	        				return;
	        			}
	        			event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', config3.getString("ShowCrateMessage").replace("[crate]", config2.getString("Info."+name+".color")+name)));
	    				Gui.showcrate(event.getPlayer(), name);
	    				event.setCancelled(true);
	    				return;
	    			}
	    		}
	    	}
		}
	}

	@EventHandler
	public void Place(BlockPlaceEvent event) {
	    FileConfiguration config1=YamlConfiguration.loadConfiguration(file);
	    FileConfiguration config2=YamlConfiguration.loadConfiguration(file1);
	    FileConfiguration config3=YamlConfiguration.loadConfiguration(file2);
	    if(event.getItemInHand()!=null&&event.getItemInHand().hasItemMeta()&&event.getItemInHand().getItemMeta().hasDisplayName()&&event.getItemInHand().getItemMeta().getDisplayName().startsWith("¡ìaÏä¡ì2×Ó¡ì5£º")) {
	    	String title = ChatColor.stripColor(event.getItemInHand().getItemMeta().getDisplayName().replace("¡ìaÏä¡ì2×Ó¡ì5£º", ""));
	    	int a = 0;
	    	for(String name:config2.getConfigurationSection("Info").getKeys(false)) {
	    		if(name.equals(title)) {
	    			break;
	    		}
	    		a++;
	    		if(a==config2.getConfigurationSection("Info").getKeys(false).size()) {
	    			a=0;
	    			return;
	    		}
	    	}
	    	a=0;
	    	List<String> Location = config2.getStringList("Location");
	    	Location.add(event.getBlock().getLocation().getWorld().getName()+":"+event.getBlock().getLocation().getBlockX()+":"+event.getBlock().getLocation().getBlockY()+":"+event.getBlock().getLocation().getBlockZ()+":"+ChatColor.stripColor(event.getItemInHand().getItemMeta().getDisplayName().replace("¡ìaÏä¡ì2×Ó¡ì5£º", "")));
	    	config2.set("Location", Location);
	  		try {
	  			config2.save(file1);
	  		} catch (IOException e) {
	  			e.printStackTrace();
	    	}
	    }
	}

	@EventHandler
	public void Click(InventoryClickEvent player) {
	    FileConfiguration config1=YamlConfiguration.loadConfiguration(file);
	    FileConfiguration config2=YamlConfiguration.loadConfiguration(file1);
	    FileConfiguration config3=YamlConfiguration.loadConfiguration(file2);
		Inventory inventory = player.getClickedInventory();
		if(inventory == null) {
			return;
		}
	    Player p = (Player) player.getWhoClicked();
	    if (!(player.getWhoClicked() instanceof Player)) {
	        return;
	    }
	    if(player.getClickedInventory().getTitle().equals(p.getInventory().getTitle())) {
	    	if(p.getOpenInventory().getTitle().startsWith("¡ìcÑ¡¡ì4Ôñ")||p.getOpenInventory().getTitle().startsWith("¡ìa³é½±Ïä¡ì2ÁÐ±í¡ì5£º¡ìdµÚ¡ìe")||p.getOpenInventory().getTitle().startsWith("¡ìc³é½±Ïä£º")) {
	    		player.setCancelled(true);
	    	}else if(p.getOpenInventory().getTitle().startsWith("¡ìc³é½±Ïä£º")||p.getOpenInventory().getTitle().startsWith("¡ì3ÉèÖÃ")||p.getOpenInventory().getTitle().startsWith("¡ì3Ïë¶Ô")) {
	    		player.setCancelled(true);
	    	}else if(p.getOpenInventory().getTitle().startsWith("¡ìa³é½±Ïä¡ì2ÁÐ±í¡ì5£º¡ìdµÚ¡ìe")||p.getOpenInventory().getTitle().startsWith("¡ìaÕýÔÚ¿ªÏä")||p.getOpenInventory().getTitle().startsWith("¡ì6³é½±ÏäÉèÖÃ¡ìb£º")||p.getOpenInventory().getTitle().startsWith("¡ìdÉèÖÃ³é½±Ïä")) {
	    		player.setCancelled(true);
	    	}
	    }
	    if(player.getClickedInventory().getTitle().equals("¡ìcÑ¡¡ì4Ôñ")) {
	    	player.setCancelled(true);
			if(player.getCurrentItem() == null || player.getCurrentItem().getType() == Material.AIR) {
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ì5´´½¨Ò»¸öÐÂµÄ³é½±Ïä")) {
				p.closeInventory();
	            Conversation conversation = new Conversation(Main.getInstance(), p, new Name());
	            p.beginConversation(conversation);
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ìa½øÈëÒÑÓÐµÄ³é½±ÏäÉèÖÃ")) {
				p.closeInventory();
				Gui.cratelist(p, 1);
			}
	    }
	    if(player.getClickedInventory().getTitle().startsWith("¡ìa³é½±Ïä¡ì2ÁÐ±í¡ì5£º¡ìdµÚ¡ìe")) {
	    	player.setCancelled(true);
			String title = player.getClickedInventory().getTitle();
			int type = Integer.parseInt(title.replace("¡ìa³é½±Ïä¡ì2ÁÐ±í¡ì5£º¡ìdµÚ¡ìe", "").replace("¡ìdÒ³", ""));
			if(player.getCurrentItem() == null || player.getCurrentItem().getType() == Material.AIR) {
				return;
			}
			if (player.getSlot() == 53&&player.getClickedInventory().getItem(53).getItemMeta().getDisplayName().equals("¡ìaÏÂÒ»Ò³")) {
				Gui.cratelist(p,++type);
			}
			if (player.getSlot() == 45&&player.getClickedInventory().getItem(45).getItemMeta().getDisplayName().equals("¡ìaÉÏÒ»Ò³")) {
				Gui.cratelist(p,--type);
			}
			if(player.getSlot() >44) {
				return;
			}
			String cratename = ChatColor.stripColor(player.getCurrentItem().getItemMeta().getDisplayName().replace("¡ì6³é½±ÏäÉèÖÃ¡ìb£º", ""));
			Gui.choose(p, cratename);
			return;
	    }
	    if(player.getClickedInventory().getTitle().startsWith("¡ìc³é½±Ïä£º")||player.getClickedInventory().getTitle().startsWith("¡ìaÕýÔÚ¿ªÏä")||player.getClickedInventory().getTitle().startsWith("¡ìcÕýÔÚ¾ÅÁ¬¡ìa¿ªÏä")) {
	    	player.setCancelled(true);
	    	return;
	    }
	    if(player.getClickedInventory().getTitle().startsWith("¡ì6³é½±Ïä¡ìc£º")) {
	    	if(player.getCurrentItem()!=null&&player.getCurrentItem().hasItemMeta()&&player.getCurrentItem().getItemMeta().hasDisplayName()&&(player.getCurrentItem().getItemMeta().getDisplayName().contains("ÁìÈ¡ÄãµÄ½±Àø°É£¡")||player.getCurrentItem().getItemMeta().getDisplayName().contains("¡ì2½öÕ¹Ê¾")))
	        	player.setCancelled(true);
	    		return;
	    }
	    if(player.getClickedInventory().getTitle().startsWith("¡ìc³é½±¡ì6Ïä£º")) {
	    	if(player.getCurrentItem()!=null&&player.getCurrentItem().hasItemMeta()&&player.getCurrentItem().getItemMeta().hasDisplayName()&&(player.getCurrentItem().getItemMeta().getDisplayName().contains("ÁìÈ¡ÄãµÄÕ½ÀûÆ·°É£¡")||player.getCurrentItem().getItemMeta().getDisplayName().contains("¡ì2½öÕ¹Ê¾")))
	        	player.setCancelled(true);
	    		return;
	    }
	    if(player.getClickedInventory().getTitle().startsWith("¡ì3ÉèÖÃ")) {
	    	player.setCancelled(true);
	    	String title = player.getClickedInventory().getTitle();
	    	String name = title.replace("¡ì3ÉèÖÃ", "").replace("¡ì3ÏÔÊ¾µÄÑÕÉ«", "");
	    	name = ChatColor.stripColor(name);
			if(player.getCurrentItem() == null || player.getCurrentItem().getType() == Material.AIR) {
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ì4ºìÉ«")) {
				config2.set("Info."+name+".color", "¡ì4");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ìe»ÆÉ«")) {
				config2.set("Info."+name+".color", "¡ìe");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ì3À¶É«")) {
				config2.set("Info."+name+".color", "¡ì3");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ì1ÉîÀ¶É«")) {
				config2.set("Info."+name+".color", "¡ì1");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ì0ºÚÉ«")) {
				config2.set("Info."+name+".color", "¡ì0");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ì5×ÏÉ«")) {
				config2.set("Info."+name+".color", "¡ì5");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ì6³ÈÉ«")) {
				config2.set("Info."+name+".color", "¡ì6");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ìf°×É«")) {
				config2.set("Info."+name+".color", "¡ìf");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ìaÇ³ÂÌÉ«")) {
				config2.set("Info."+name+".color", "¡ìa");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ì2ÂÌÉ«")) {
				config2.set("Info."+name+".color", "¡ì2");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ì6³ÈÉ«")) {
				config2.set("Info."+name+".color", "¡ì6");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ìbÌìÀ¶É«")) {
				config2.set("Info."+name+".color", "¡ìb");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ìc·ÛºìÉ«")) {
				config2.set("Info."+name+".color", "¡ìc");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ìdÁÁ×ÏÉ«")) {
				config2.set("Info."+name+".color", "¡ìd");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ì7»ÒÉ«")) {
				config2.set("Info."+name+".color", "¡ì7");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ìa·µ»ØÉèÖÃÁÐ±í")) {
				p.closeInventory();
				Gui.choose(p, name);
				return;
			}
	    }
	    if(player.getClickedInventory().getTitle().startsWith("¡ìdÉèÖÃ³é½±Ïä")) {
	    	player.setCancelled(true);
			String title = player.getClickedInventory().getTitle();
			String name = ChatColor.stripColor(title.replace("ÉèÖÃ³é½±Ïä", "").replace("µÄ¿ªÏä·½Ê½", ""));
			if(player.getCurrentItem() == null || player.getCurrentItem().getType() == Material.AIR) {
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equalsIgnoreCase("¡ì6µã»÷¶ÔÓ¦µÄ·½¿é£¬ÉèÖÃ¶ÔÓ¦µÄ¿ªÏä¶¯»­")) {
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ìa¹Ì¶¨ÖÐ¼ä³é½±")) {
				config2.set("Info."+name+".type", "normal");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
		  		p.sendMessage("¡ìa³É¹¦ÉèÖÃ");
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ìc¾ÅÁ¬³é¡ìd£º¡ìa¹Ì¶¨ÖÐ¼ä³é½±")) {
				config2.set("Info."+name+".ninetype", "normal");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
		  		p.sendMessage("¡ìa³É¹¦ÉèÖÃ");
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ìeËæ»úÎ»ÖÃ³é½±")) {
				config2.set("Info."+name+".type", "random");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
		  		p.sendMessage("¡ìa³É¹¦ÉèÖÃ");
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ìc¾ÅÁ¬³é¡ìd£º¡ìeËæ»úÎ»ÖÃ³é½±")) {
				config2.set("Info."+name+".ninetype", "random");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
		  		p.sendMessage("¡ìa³É¹¦ÉèÖÃ");
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ìb·¶Î§Î»ÖÃÄÚ³é½±")) {
				config2.set("Info."+name+".type", "order");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
		  		p.sendMessage("¡ìa³É¹¦ÉèÖÃ");
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ìc¾ÅÁ¬³é¡ìd£º¡ìb·¶Î§Î»ÖÃÄÚ³é½±")) {
				config2.set("Info."+name+".ninetype", "order");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
		  		p.sendMessage("¡ìa³É¹¦ÉèÖÃ");
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ìbÓÐÎïÆ·µÄËæ»ú³é½±")) {
				config2.set("Info."+name+".type", "embellishment");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
		  		p.sendMessage("¡ìa³É¹¦ÉèÖÃ");
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ìc¾ÅÁ¬³é¡ìd£º¡ì6¿ìÀÖ¾ØÐÎ³é½±")) {
				config2.set("Info."+name+".ninetype", "gradient");
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
		  		p.sendMessage("¡ìa³É¹¦ÉèÖÃ");
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ìa·µ»ØÉèÖÃÁÐ±í")) {
				p.closeInventory();
				Gui.choose(p, name);
				return;
			}
	    	return;
	    }
	    if(player.getClickedInventory().getTitle().startsWith("¡ì3Ïë¶Ô")) {
	    	player.setCancelled(true);
			String title = player.getClickedInventory().getTitle();
			String name = ChatColor.stripColor(title.replace("¡ì3Ïë¶Ô", "").replace("¡ì3½øÐÐÊ²Ã´²Ù×÷£¿", ""));
			if(player.getCurrentItem() == null || player.getCurrentItem().getType() == Material.AIR) {
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ì5ÐÞ¸Ä½±³Ø½±Àø")) {
				Gui.setcrate(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ì6ÉèÖÃÑÕÉ«")) {
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().startsWith("¡ìaÉèÖÃ")) {
				Gui.way(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("¡ìcÉ¾³ýÕâ¸öÏä×Ó")) {
				config2.set("Info."+name, null);
		  		try {
		  			config2.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
		  		for(Player players:Bukkit.getOnlinePlayers()) {
		  			if(players.getOpenInventory().getTitle().startsWith("¡ìa³é½±Ïä¡ì2ÁÐ±í¡ì5£º¡ìdµÚ¡ìe")) {
		  				String titles = players.getOpenInventory().getTitle();
		  				int type = Integer.parseInt(titles.replace("¡ìa³é½±Ïä¡ì2ÁÐ±í¡ì5£º¡ìdµÚ¡ìe", "").replace("¡ìdÒ³", ""));
		  				players.closeInventory();
		  				Gui.cratelist(players, type);
		  			}else if(players.getOpenInventory().getTitle().startsWith("¡ì2³é½±Ïä"+config2.getString("Info."+name+".color")+name)) {
		  					players.closeInventory();
		  					players.sendMessage("¡ìaÕâ¸ö³é½±Ïä±»¡ìc"+p.getName()+"¡ìaÉ¾³ý£¡");
		  			}else if(players.getOpenInventory().getTitle().equals(title)) {
	  					players.closeInventory();
	  					players.sendMessage("¡ìaÕâ¸ö³é½±Ïä±»¡ìc"+p.getName()+"¡ìaÉ¾³ý£¡");
		  			}else if(players.getOpenInventory().getTitle().startsWith(ChatColor.stripColor("ÉèÖÃ"+config2.getString("Info."+name+".color")+name+"ÏÔÊ¾µÄÑÕÉ«"))) {
	  					players.closeInventory();
	  					players.sendMessage("¡ìaÕâ¸ö³é½±Ïä±»¡ìc"+p.getName()+"¡ìaÉ¾³ý£¡");
		  			}else if(player.getClickedInventory().getTitle().startsWith(ChatColor.stripColor("¡ìdÉèÖÃ³é½±Ïä"+config2.getString("Info."+name+".color")+name+"µÄ¿ªÏä·½Ê½"))) {
	  					players.closeInventory();
	  					players.sendMessage("¡ìaÕâ¸ö³é½±Ïä±»¡ìc"+p.getName()+"¡ìaÉ¾³ý£¡");
		  			}
		  		}
				p.sendMessage("¡ìcÉ¾³ý¡ìa"+name+"¡ìc³É¹¦");
				return;
			}
	    }
	}

	@EventHandler
public void Close(InventoryCloseEvent event) {
    FileConfiguration config1=YamlConfiguration.loadConfiguration(file);
    FileConfiguration config2=YamlConfiguration.loadConfiguration(file1);
    FileConfiguration config3=YamlConfiguration.loadConfiguration(file2);
    if(event.getInventory().getTitle().startsWith("¡ì2³é½±Ïä")) {
    	String title = ChatColor.stripColor(event.getInventory().getTitle().replace("¡ì2³é½±Ïä", "").replace("¡ì2ÉèÖÃ", ""));
    	ArrayList<String> data = new ArrayList<String>();
  		int a=0;
  		while(a<54) {
  			String item = null;
  			if(event.getInventory().getItem(a)==null||event.getInventory().getItem(a).getType()==Material.AIR)
  			item = "null";
  			else
  			item = ItemData(event.getInventory().getItem(a));
  			data.add(a+":"+item);
  			a++;
  		}
  		a=0;
  		List<String> exist = config2.getStringList("Info."+title+".data");
  		if(exist.size()==0) {
  			config2.set("Info."+title+".color", "¡ìf");
  			config2.set("Info."+title+".animation", true);
  			config2.set("Info."+title+".nineanimation", true);
  			config2.set("Info."+title+".announcement", "ÎÞ");
  			config2.set("Info."+title+".nine", "ÎÞ");
  			config2.set("Info."+title+".number", -1);
  			config2.set("Info."+title+".cd", -1);
  			config2.set("Info."+title+".ninenumber", -1);
  			config2.set("Info."+title+".ninecd", -1);
  			config2.set("Info."+title+".type", "normal");
  			config2.set("Info."+title+".ninetype", "normal");
  			config2.set("Info."+title+".clear", false);
  			config2.set("Info."+title+".info", false);
  			config2.set("Info."+title+".nineinfo", false);
  			crate = null;
  		}
  		config2.set("Info."+title+".data", data);
  		try {
  			config2.save(file1);
  		} catch (IOException e) {
  			e.printStackTrace();
    	}
  		Player player = (Player) event.getPlayer();
  		player.sendMessage("¡ìa±£´æ³É¹¦");
  		for(Player players:Bukkit.getOnlinePlayers()) {
  			if(players.getOpenInventory().getTitle().startsWith("¡ìa³é½±Ïä¡ì2ÁÐ±í¡ì5£º¡ìdµÚ¡ìe")) {
  				String titles = players.getOpenInventory().getTitle();
  				int type = Integer.parseInt(titles.replace("¡ìa³é½±Ïä¡ì2ÁÐ±í¡ì5£º¡ìdµÚ¡ìe", "").replace("¡ìdÒ³", ""));
  				players.closeInventory();
  				Gui.cratelist(players, type);
			}
		}	
    	return;
    }
    
}
    @EventHandler
    public void Death(PlayerDeathEvent a) {
    	Player killer = a.getEntity().getKiller();
    	a.getEntity().getKiller().addPotionEffect(new PotionEffect(PotionEffectType.SPEED, Integer.MAX_VALUE, 1));
    }

	//	ItemStack×ªString
	public static String ItemData(ItemStack item) {
		StreamSerializer data = new StreamSerializer();
		String s;
		try {
		    s = data.serializeItemStack(item);
		} catch (Exception e) {
		    s = null;
		}
		return s;
	}
//	String×ªItemStack
	public static ItemStack GetItemStack(String data) {
		StreamSerializer item = new StreamSerializer();
		try {
			return item.deserializeItemStack(data);
		} catch (Exception e) {
			e.printStackTrace();
		}
		return null;
	}
}
