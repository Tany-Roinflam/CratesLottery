package com.tany.crateslottery.listenevent;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.conversations.Conversation;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.block.Action;
import org.bukkit.event.block.BlockBreakEvent;
import org.bukkit.event.block.BlockPlaceEvent;
import org.bukkit.event.inventory.InventoryClickEvent;
import org.bukkit.event.inventory.InventoryCloseEvent;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.event.player.PlayerQuitEvent;
import org.bukkit.event.player.PlayerToggleSneakEvent;
import org.bukkit.inventory.Inventory;
import org.bukkit.inventory.ItemStack;
import org.bukkit.plugin.Plugin;
import com.comphenix.protocol.utility.StreamSerializer;
import com.tany.crateslottery.Main;
import com.tany.crateslottery.Other;
import com.tany.crateslottery.conversation.Name;
import com.tany.crateslottery.gui.Gui;
import com.tany.crateslottery.task.NineWingTask;
import com.tany.crateslottery.task.NineWingTaskS;
import com.tany.crateslottery.task.WingTask;
import com.tany.crateslottery.task.WingTaskS;

public class Event implements Listener  {
	public static String crate = null;
	Set<String> Sneak = new HashSet<>();
    Plugin config = Bukkit.getPluginManager().getPlugin("CratesLottery");
    File file1=new File(config.getDataFolder(),"data.yml");
    
    @EventHandler
	public void Toggle(PlayerToggleSneakEvent event) {
		if(event.isSneaking()) {
			Sneak.add(event.getPlayer().getName());
		}else if(Sneak.contains(event.getPlayer().getName())){
			Sneak.remove(event.getPlayer().getName());
		}
	}
    
    @EventHandler
	public void leave(PlayerQuitEvent event) {
    	if(Sneak.contains(event.getPlayer().getName())) {
    		Sneak.remove(event.getPlayer().getName());
    	}
	}

	@EventHandler
    public void Break(BlockBreakEvent event) {
        List<String> Location = Other.data.getStringList("Location");
        Location block = event.getBlock().getLocation();
        if(Location.size()!=0) {
        	for(String location:Location) {
				String world = location.split(":")[0];
				int x = Integer.parseInt(location.split(":")[1]);
				int y = Integer.parseInt(location.split(":")[2]);
				int z = Integer.parseInt(location.split(":")[3]);
				if(block.getBlockX()==x&&block.getBlockY()==y&&block.getBlockZ()==z&&block.getWorld().equals(Bukkit.getWorld(world))) {
					if(event.getPlayer().isOp()) {
						if(Sneak.contains(event.getPlayer().getName())) {
							event.getPlayer().sendMessage("°Ïa≥…π¶∆∆ªµ≥ÈΩ±œ‰£°");
							Location.remove(location);
							Other.data.set("Location", Location);
					  		try {
					  			Other.data.save(file1);
					  		} catch (IOException e) {
					  			e.printStackTrace();
				        	}
						}
					}else {
						event.setCancelled(true);
						event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("BreakCrateMessage")));
					}
					return;
				}
        	}
        }
    }
    
    @EventHandler
	public void Place(BlockPlaceEvent event) {
		if(event.isCancelled())
			return;
	    if(event.getItemInHand()!=null&&event.getItemInHand().hasItemMeta()&&event.getItemInHand().getItemMeta().hasDisplayName()&&event.getItemInHand().getItemMeta().getDisplayName().startsWith(ChatColor.translateAlternateColorCodes('&', Other.message.getString("CrateLottery")))) {
	    	String title = ChatColor.stripColor(event.getItemInHand().getItemMeta().getDisplayName().replace(ChatColor.translateAlternateColorCodes('&', Other.message.getString("CrateLottery")), ""));
	    	int a = 0;
	    	for(String name:Other.data.getConfigurationSection("Info").getKeys(false)) {
	    		if(name.equals(title)) {
	    			break;
	    		}
	    		a++;
	    		if(a==Other.data.getConfigurationSection("Info").getKeys(false).size()) {
	    			a=0;
	    			return;
	    		}
	    	}		
	    	a=0;
	    	List<String> Location = Other.data.getStringList("Location");
	    	if(!Location.contains(event.getBlock().getLocation().getWorld().getName()+":"+event.getBlock().getLocation().getBlockX()+":"+event.getBlock().getLocation().getBlockY()+":"+event.getBlock().getLocation().getBlockZ()+":"+ChatColor.stripColor(event.getItemInHand().getItemMeta().getDisplayName().replace(ChatColor.translateAlternateColorCodes('&', Other.message.getString("CrateLottery")), "")))) {
	    		Location.add(event.getBlock().getLocation().getWorld().getName()+":"+event.getBlock().getLocation().getBlockX()+":"+event.getBlock().getLocation().getBlockY()+":"+event.getBlock().getLocation().getBlockZ()+":"+ChatColor.stripColor(event.getItemInHand().getItemMeta().getDisplayName().replace(ChatColor.translateAlternateColorCodes('&', Other.message.getString("CrateLottery")), "")));
	    	}
	    	Other.data.set("Location", Location);
	  		try {
	  			Other.data.save(file1);
	  		} catch (IOException e) {
	  			e.printStackTrace();
	    	}
	  		return;
	    }
	}

	@EventHandler
	public void onInteract(PlayerInteractEvent event) {
		if(!event.getAction().equals(Action.LEFT_CLICK_AIR)&&!event.getAction().equals(Action.RIGHT_CLICK_AIR)) {
	    	List<String> Location = Other.data.getStringList("Location");
	    	Location block = event.getClickedBlock().getLocation();
	    	if(Location.size()!=0) {
	    		for(String location:Location) {
	    			String world = location.split(":")[0];
	    			int x = Integer.parseInt(location.split(":")[1]);
	    			int y = Integer.parseInt(location.split(":")[2]);
	    			int z = Integer.parseInt(location.split(":")[3]);
	    			String names = location.split(":")[4];
	    			if(block.getBlockX()==x&&block.getBlockY()==y&&block.getBlockZ()==z&&block.getWorld().equals(Bukkit.getWorld(world))) {
	        			if(Other.data.getString("Info."+names+".color")==null) {
	        				event.getClickedBlock().setType(Material.AIR);
	        				event.setCancelled(true);
	        				event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("ClearCrateMessage")));
							Location.remove(location);
							Other.data.set("Location", Location);
					  		try {
					  			Other.data.save(file1);
					  		} catch (IOException e) {
					  			e.printStackTrace();
				        	}
	        				return;
	        			}
	    			}
	    		}
	    	}
		}
		if(event.getItem()!=null&&event.getItem().getItemMeta().hasDisplayName()&&event.getItem().getItemMeta().getDisplayName().startsWith(ChatColor.translateAlternateColorCodes('&', Other.message.getString("CrateLotteryKey")))) {
			event.setCancelled(true);
			String name = ChatColor.stripColor(event.getItem().getItemMeta().getDisplayName().replace(ChatColor.translateAlternateColorCodes('&', Other.message.getString("CrateLotteryKey")), ""));
			if(Other.data.getString("Info."+name+".color")==null) {
				event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("ClearKeyMessage")));
				event.getPlayer().getInventory().setItemInHand(null);
	    		return;
			}
			if(!Other.config.getBoolean("UnPackAnyTime")&&event.getAction().equals(Action.RIGHT_CLICK_AIR)) {
				event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("UseKeyMessage")));
				return;
			}
			if(Other.config.getBoolean("UnPackAnyTime")) {
				if(event.getAction().equals(Action.LEFT_CLICK_AIR)) {
        			event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("ShowCrateMessage").replace("[crate]", Other.data.getString("Info."+name+".color")+name)));
    				Gui.showcrate(event.getPlayer(), name);
    				event.setCancelled(true);
    				return;
				}
				if(event.getAction().equals(Action.RIGHT_CLICK_AIR)) {
					if(Sneak.contains(event.getPlayer().getName())) {
    					if(!event.getPlayer().hasPermission("cl.ninelottery")) {
    						event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoNineLotteryMessage")));
    						return;
    					}
    					if(Other.data.getBoolean("Info."+name+".clear")) {
    						event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("ClearMessage")));
    						return;
    					}
    					if(!event.getPlayer().hasPermission("cl.allcrate")&&!event.getPlayer().hasPermission("cl.crate."+name)) {
    						event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoOpenCrate".replace("[crate]", Other.data.getString("Info."+name+".color")+name))));
    						return;
    					}
						List<String> itemlist = Other.data.getStringList("Info."+name+".data");
						int a=1;
						if(itemlist.size()==0) {
							event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoItemMessage")));
							return;
						}
						for(String item:itemlist) {
						if(!item.split(":")[1].equals("null")) {
							break;
						}
						if(a==itemlist.size()) {
							event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoItemMessage")));
							return;
						}
						a++;
						}
						a=1;
    					if(event.getPlayer().getInventory().getItemInHand().getAmount()<9) {
    						event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoNineKeyMessage")));
    						return;
    					}
    					int amount = event.getPlayer().getInventory().getItemInHand().getAmount();
    					amount=amount-9;
    	    				if(amount!=0)
        	    			event.getPlayer().getInventory().getItemInHand().setAmount(amount);
        	    			else
							event.getPlayer().getInventory().setItemInHand(null);
    	    			if(!Other.data.getString("Info."+name+".nine").equals("Œﬁ"))
    	    				Bukkit.broadcastMessage(ChatColor.translateAlternateColorCodes('&', Other.data.getString("Info."+name+".nine").replace("[player]", event.getPlayer().getName())));
    	    			event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NineOpenCrateMessage").replace("[crate]", Other.data.getString("Info."+name+".color")+name)));
    					if(Other.data.getBoolean("Info."+name+".nineanimation")) {
    						if(Other.data.getDouble("Info."+name+".ninecd")<=0&&Other.data.getDouble("Info."+name+".ninenumber")<=0)
    						new NineWingTask(event.getPlayer(), name,Other.config.getInt("NineWingLongTime")).runTaskTimer(Main.plugin, 0, (int) (Other.config.getDouble("NineWingSpaceTime")*20));
    						else
    						new NineWingTask(event.getPlayer(), name,Other.data.getInt("Info."+name+".ninenumber")).runTaskTimer(Main.plugin, 0, (int) (Other.data.getDouble("Info."+name+".ninecd")*20));
    					} else {
    						new NineWingTaskS(event.getPlayer(), name).runTaskTimer(Main.plugin, 0, 0);
    					}
        				return;
					} else {
    					if(!event.getPlayer().hasPermission("cl.lottery")) {
    						event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoLotteryMessage")));
    						return;
    					}
    					List<String> itemlist = Other.data.getStringList("Info."+name+".data");
    					int a=1;
    					if(itemlist.size()==0) {
							event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoItemMessage")));
							return;
    					}
    					if(!event.getPlayer().hasPermission("cl.allcrate")&&!event.getPlayer().hasPermission("cl.crate."+name)) {
    						event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoOpenCrate".replace("[crate]", Other.data.getString("Info."+name+".color")+name))));
    						return;
    					}
    					for(String item:itemlist) {
    						if(!item.split(":")[1].equals("null")) {
    							break;
    						}
    						if(a==itemlist.size()) {
    							event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoItemMessage")));
    							return;
    						}
    						a++;
    					}
    					int amount = event.getPlayer().getInventory().getItemInHand().getAmount();
    					amount--;
    	    				if(amount!=0)
        	    			event.getPlayer().getInventory().getItemInHand().setAmount(amount);
        	    			else
							event.getPlayer().getInventory().setItemInHand(null);
    	    			if(!Other.data.getString("Info."+name+".announcement").equals("Œﬁ"))
    	    				Bukkit.broadcastMessage(ChatColor.translateAlternateColorCodes('&', Other.data.getString("Info."+name+".announcement").replace("[player]", event.getPlayer().getName())));
    	    			event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("OpenCrateMessage").replace("[crate]", Other.data.getString("Info."+name+".color")+name)));
    					if(Other.data.getBoolean("Info."+name+".animation")) {
    						if(Other.data.getDouble("Info."+name+".cd")<=0&&Other.data.getDouble("Info."+name+".number")<=0)
    						new WingTask(event.getPlayer(), name, Other.config.getInt("WingLongTime")).runTaskTimer(Main.plugin, 0, (int) (Other.config.getDouble("WingSpaceTime")*20));
    						else
    						new WingTask(event.getPlayer(), name, Other.data.getInt("Info."+name+".number")).runTaskTimer(Main.plugin, 0, (int) (Other.data.getDouble("Info."+name+".cd")*20));
    					}else {
    						new WingTaskS(event.getPlayer(), name).runTaskTimer(Main.plugin, 0, 0);
    					}
        				return;
					}
				}
			}
		}
		if(event.getClickedBlock()!=null&&event.getAction().equals(Action.RIGHT_CLICK_BLOCK)) {
	    	List<String> Location = Other.data.getStringList("Location");
	    	Location block = event.getClickedBlock().getLocation();
	    	if(Location.size()!=0) {
	    		for(String location:Location) {
	    			String world = location.split(":")[0];
	    			int x = Integer.parseInt(location.split(":")[1]);
	    			int y = Integer.parseInt(location.split(":")[2]);
	    			int z = Integer.parseInt(location.split(":")[3]);
	    			String name = location.split(":")[4];
	    			if(block.getBlockX()==x&&block.getBlockY()==y&&block.getBlockZ()==z&&block.getWorld().equals(Bukkit.getWorld(world))) {
	    				event.setCancelled(true);
						if(event.getPlayer().getInventory().getItemInHand()==null||event.getPlayer().getInventory().getItemInHand().getType()==Material.AIR) {
							event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoOpenCrateMessage").replace("[key]", Other.data.getString("Info."+name+".color")+name)));
							return;
						}else if(!event.getPlayer().getInventory().getItemInHand().getItemMeta().hasDisplayName()) {
							event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoOpenCrateMessage").replace("[key]", Other.data.getString("Info."+name+".color")+name)));
							return;
						}else if(!ChatColor.stripColor(event.getPlayer().getInventory().getItemInHand().getItemMeta().getDisplayName().replace(ChatColor.translateAlternateColorCodes('&', Other.message.getString("CrateLotteryKey")), "")).equals(name)) {
							event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoOpenCrateMessage").replace("[key]", Other.data.getString("Info."+name+".color")+name)));
							return;
						}
    				if(Sneak.contains(event.getPlayer().getName())) {
    					if(!event.getPlayer().hasPermission("cl.ninelottery")) {
    						event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoNineLotteryMessage")));
    						return;
    					}
    					if(Other.data.getBoolean("Info."+name+".clear")) {
    						event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("ClearMessage")));
    						return;
    					}
    					if(!event.getPlayer().hasPermission("cl.allcrate")&&!event.getPlayer().hasPermission("cl.crate."+name)) {
    						event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoOpenCrate".replace("[crate]", Other.data.getString("Info."+name+".color")+name))));
    						return;
    					}
        					List<String> itemlist = Other.data.getStringList("Info."+name+".data");
        					int a=1;
        					if(itemlist.size()==0) {
    							event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoItemMessage")));
    							return;
        					}
        					for(String item:itemlist) {
    						if(!item.split(":")[1].equals("null")) {
    							break;
    						}
    						if(a==itemlist.size()) {
    							event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoItemMessage")));
    							return;
    						}
    						a++;
    						}
    						a=1;
        					if(event.getPlayer().getInventory().getItemInHand().getAmount()<9) {
        						event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoNineKeyMessage")));
        						return;
        					}
        					int amount = event.getPlayer().getInventory().getItemInHand().getAmount();
        					amount=amount-9;
        	    				if(amount!=0)
            	    			event.getPlayer().getInventory().getItemInHand().setAmount(amount);
            	    			else
  								event.getPlayer().getInventory().setItemInHand(null);
        	    			if(!Other.data.getString("Info."+name+".nine").equals("Œﬁ"))
        	    				Bukkit.broadcastMessage(ChatColor.translateAlternateColorCodes('&', Other.data.getString("Info."+name+".nine").replace("[player]", event.getPlayer().getName())));
        	    			event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NineOpenCrateMessage").replace("[crate]", Other.data.getString("Info."+name+".color")+name)));
        					if(Other.data.getBoolean("Info."+name+".nineanimation")) {
        						if(Other.data.getDouble("Info."+name+".ninecd")<=0&&Other.data.getDouble("Info."+name+".ninenumber")<=0)
        						new NineWingTask(event.getPlayer(), name,Other.config.getInt("NineWingLongTime")).runTaskTimer(Main.plugin, 0, (int) (Other.config.getDouble("NineWingSpaceTime")*20));
        						else
        						new NineWingTask(event.getPlayer(), name,Other.data.getInt("Info."+name+".ninenumber")).runTaskTimer(Main.plugin, 0, (int) (Other.data.getDouble("Info."+name+".ninecd")*20));
        					}else {
        						new NineWingTaskS(event.getPlayer(), name).runTaskTimer(Main.plugin, 0, 0);
        					}
            				return;
	    				}else {
	    					if(!event.getPlayer().hasPermission("cl.lottery")) {
	    						event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoLotteryMessage")));
	    						return;
	    					}
	    					List<String> itemlist = Other.data.getStringList("Info."+name+".data");
	    					int a=1;
        					if(itemlist.size()==0) {
    							event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoItemMessage")));
    							return;
        					}
	    					if(!event.getPlayer().hasPermission("cl.allcrate")&&!event.getPlayer().hasPermission("cl.crate."+name)) {
	    						event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoOpenCrate".replace("[crate]", Other.data.getString("Info."+name+".color")+name))));
	    						return;
	    					}
	    					for(String item:itemlist) {
	    						if(!item.split(":")[1].equals("null")) {
	    							break;
	    						}
	    						if(a==itemlist.size()) {
	    							event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("NoItemMessage")));
	    							return;
	    						}
	    						a++;
	    					}
	    					int amount = event.getPlayer().getInventory().getItemInHand().getAmount();
	    					amount--;
	    	    				if(amount!=0)
	        	    			event.getPlayer().getInventory().getItemInHand().setAmount(amount);
	        	    			else
								event.getPlayer().getInventory().setItemInHand(null);
	    	    			if(!Other.data.getString("Info."+name+".announcement").equals("Œﬁ"))
	    	    				Bukkit.broadcastMessage(ChatColor.translateAlternateColorCodes('&', Other.data.getString("Info."+name+".announcement").replace("[player]", event.getPlayer().getName())));
	    	    			event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("OpenCrateMessage").replace("[crate]", Other.data.getString("Info."+name+".color")+name)));
	    					if(Other.data.getBoolean("Info."+name+".animation")) {
	    						if(Other.data.getDouble("Info."+name+".cd")<=0&&Other.data.getDouble("Info."+name+".number")<=0)
	    						new WingTask(event.getPlayer(), name, Other.config.getInt("WingLongTime")).runTaskTimer(Main.plugin, 0, (int) (Other.config.getDouble("WingSpaceTime")*20));
	    						else
	    						new WingTask(event.getPlayer(), name, Other.data.getInt("Info."+name+".number")).runTaskTimer(Main.plugin, 0, (int) (Other.data.getDouble("Info."+name+".cd")*20));
	    					}else {
	    						new WingTaskS(event.getPlayer(), name).runTaskTimer(Main.plugin, 0, 0);
	    					}
	        				return;
	        			}
	    			}
	    		}
	    	}
		}
		if(event.getAction().equals(Action.LEFT_CLICK_BLOCK)&&!Sneak.contains(event.getPlayer().getName())) {
	    	List<String> Location = Other.data.getStringList("Location");
	    	Location block = event.getClickedBlock().getLocation();
	    	if(Location.size()!=0) {
	    		for(String location:Location) {
	    			String world = location.split(":")[0];
	    			int x = Integer.parseInt(location.split(":")[1]);
	    			int y = Integer.parseInt(location.split(":")[2]);
	    			int z = Integer.parseInt(location.split(":")[3]);
	    			String name = location.split(":")[4];
	    			if(block.getBlockX()==x&&block.getBlockY()==y&&block.getBlockZ()==z&&block.getWorld().equals(Bukkit.getWorld(world))) {
	        			event.getPlayer().sendMessage(ChatColor.translateAlternateColorCodes('&', Other.message.getString("ShowCrateMessage").replace("[crate]", Other.data.getString("Info."+name+".color")+name)));
	    				Gui.showcrate(event.getPlayer(), name);
	    				event.setCancelled(true);
	    				return;
	    			}
	    		}
	    	}
		}
	}

	@EventHandler
	public void Click(InventoryClickEvent player) {
		Inventory inventory = player.getClickedInventory();
		if(inventory == null) {
			return;
		}
	    Player p = (Player) player.getWhoClicked();
	    if (!(player.getWhoClicked() instanceof Player)) {
	        return;
	    }
	    if(player.getClickedInventory().getTitle().equals(p.getInventory().getTitle())) {
	    	if(p.getOpenInventory().getTitle().startsWith("°Ïc—°°Ï4‘Ò")||p.getOpenInventory().getTitle().startsWith("°Ïa≥ÈΩ±œ‰°Ï2¡–±Ì°Ï5£∫°Ïdµ⁄°Ïe")||p.getOpenInventory().getTitle().startsWith("°Ïc≥ÈΩ±œ‰£∫")) {
	    		player.setCancelled(true);
	    	}else if(p.getOpenInventory().getTitle().startsWith("°Ïc≥ÈΩ±œ‰£∫")||p.getOpenInventory().getTitle().startsWith("°Ï3…Ë÷√")||p.getOpenInventory().getTitle().startsWith("°Ï3œÎ∂‘")) {
	    		player.setCancelled(true);
	    	}else if(p.getOpenInventory().getTitle().startsWith("°Ïa≥ÈΩ±œ‰°Ï2¡–±Ì°Ï5£∫°Ïdµ⁄°Ïe")||p.getOpenInventory().getTitle().startsWith("°Ïa’˝‘⁄ø™œ‰")||p.getOpenInventory().getTitle().startsWith("°Ï6≥ÈΩ±œ‰…Ë÷√°Ïb£∫")||p.getOpenInventory().getTitle().startsWith("°Ïd…Ë÷√≥ÈΩ±œ‰")) {
	    		player.setCancelled(true);
	    	}
	    }
	    if(player.getClickedInventory().getTitle().equals("°Ïc—°°Ï4‘Ò")) {
	    	player.setCancelled(true);
			if(player.getCurrentItem() == null || player.getCurrentItem().getType() == Material.AIR) {
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ï5¥¥Ω®“ª∏ˆ–¬µƒ≥ÈΩ±œ‰")) {
				p.closeInventory();
	            Conversation conversation = new Conversation(Main.plugin, p, new Name());
	            p.beginConversation(conversation);
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°ÏaΩ¯»Î“—”–µƒ≥ÈΩ±œ‰…Ë÷√")) {
				p.closeInventory();
				Gui.cratelist(p, 1);
			}
	    }
	    if(player.getClickedInventory().getTitle().startsWith("°Ïa≥ÈΩ±œ‰°Ï2¡–±Ì°Ï5£∫°Ïdµ⁄°Ïe")) {
	    	player.setCancelled(true);
			String title = player.getClickedInventory().getTitle();
			int type = Integer.parseInt(title.replace("°Ïa≥ÈΩ±œ‰°Ï2¡–±Ì°Ï5£∫°Ïdµ⁄°Ïe", "").replace("°Ïd“≥", ""));
			if(player.getCurrentItem() == null || player.getCurrentItem().getType() == Material.AIR) {
				return;
			}
			if (player.getSlot() == 53&&player.getClickedInventory().getItem(53).getItemMeta().getDisplayName().equals("°Ïaœ¬“ª“≥")) {
				Gui.cratelist(p,++type);
			}
			if (player.getSlot() == 45&&player.getClickedInventory().getItem(45).getItemMeta().getDisplayName().equals("°Ïa…œ“ª“≥")) {
				Gui.cratelist(p,--type);
			}
			if(player.getSlot() >44) {
				return;
			}
			String cratename = ChatColor.stripColor(player.getCurrentItem().getItemMeta().getDisplayName().replace("°Ï6≥ÈΩ±œ‰…Ë÷√°Ïb£∫", ""));
			Gui.choose(p, cratename);
			return;
	    }
	    if(player.getClickedInventory().getTitle().startsWith("°Ïc≥ÈΩ±œ‰£∫")||player.getClickedInventory().getTitle().startsWith("°Ïa’˝‘⁄ø™œ‰")||player.getClickedInventory().getTitle().startsWith("°Ïc’˝‘⁄æ≈¡¨°Ïaø™œ‰")) {
	    	player.setCancelled(true);
	    	return;
	    }
	    if(player.getClickedInventory().getTitle().startsWith("°Ï6≥ÈΩ±œ‰°Ïc£∫")) {
	    	if(player.getCurrentItem()!=null&&player.getCurrentItem().hasItemMeta()&&player.getCurrentItem().getItemMeta().hasDisplayName()&&(player.getCurrentItem().getItemMeta().getDisplayName().contains("¡Ï»°ƒ„µƒΩ±¿¯∞…£°")||player.getCurrentItem().getItemMeta().getDisplayName().contains("°Ï2Ωˆ’π æ")))
	        	player.setCancelled(true);
	    		return;
	    }
	    if(player.getClickedInventory().getTitle().startsWith("°Ïc≥ÈΩ±°Ï6œ‰£∫")) {
	    	if(player.getCurrentItem()!=null&&player.getCurrentItem().hasItemMeta()&&player.getCurrentItem().getItemMeta().hasDisplayName()&&(player.getCurrentItem().getItemMeta().getDisplayName().contains("¡Ï»°ƒ„µƒ’Ω¿˚∆∑∞…£°")||player.getCurrentItem().getItemMeta().getDisplayName().contains("°Ï2Ωˆ’π æ")))
	        	player.setCancelled(true);
	    		return;
	    }
	    if(player.getClickedInventory().getTitle().startsWith("°Ï3…Ë÷√")) {
	    	player.setCancelled(true);
	    	String title = player.getClickedInventory().getTitle();
	    	String name = title.replace("°Ï3…Ë÷√", "").replace("°Ï3œ‘ æµƒ—’…´", "");
	    	name = ChatColor.stripColor(name);
			if(player.getCurrentItem() == null || player.getCurrentItem().getType() == Material.AIR) {
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ï4∫Ï…´")) {
				Other.data.set("Info."+name+".color", "°Ï4");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ïeª∆…´")) {
				Other.data.set("Info."+name+".color", "°Ïe");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ï3¿∂…´")) {
				Other.data.set("Info."+name+".color", "°Ï3");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ï1…Ó¿∂…´")) {
				Other.data.set("Info."+name+".color", "°Ï1");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ï0∫⁄…´")) {
				Other.data.set("Info."+name+".color", "°Ï0");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ï5◊œ…´")) {
				Other.data.set("Info."+name+".color", "°Ï5");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ï6≥»…´")) {
				Other.data.set("Info."+name+".color", "°Ï6");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ïf∞◊…´")) {
				Other.data.set("Info."+name+".color", "°Ïf");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ïa«≥¬Ã…´")) {
				Other.data.set("Info."+name+".color", "°Ïa");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ï2¬Ã…´")) {
				Other.data.set("Info."+name+".color", "°Ï2");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ï6≥»…´")) {
				Other.data.set("Info."+name+".color", "°Ï6");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°ÏbÃÏ¿∂…´")) {
				Other.data.set("Info."+name+".color", "°Ïb");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ïc∑€∫Ï…´")) {
				Other.data.set("Info."+name+".color", "°Ïc");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ïd¡¡◊œ…´")) {
				Other.data.set("Info."+name+".color", "°Ïd");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ï7ª“…´")) {
				Other.data.set("Info."+name+".color", "°Ï7");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ïa∑µªÿ…Ë÷√¡–±Ì")) {
				p.closeInventory();
				Gui.choose(p, name);
				return;
			}
	    }
	    if(player.getClickedInventory().getTitle().startsWith("°Ïd…Ë÷√≥ÈΩ±œ‰")) {
	    	player.setCancelled(true);
			String title = player.getClickedInventory().getTitle();
			String name = ChatColor.stripColor(title.replace("…Ë÷√≥ÈΩ±œ‰", "").replace("µƒø™œ‰∑Ω Ω", ""));
			if(player.getCurrentItem() == null || player.getCurrentItem().getType() == Material.AIR) {
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equalsIgnoreCase("°Ï6µ„ª˜∂‘”¶µƒ∑ΩøÈ£¨…Ë÷√∂‘”¶µƒø™œ‰∂Øª≠")) {
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°ÏaπÃ∂®÷–º‰≥ÈΩ±")) {
				Other.data.set("Info."+name+".type", "normal");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
		  		p.sendMessage("°Ïa≥…π¶…Ë÷√");
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ïcæ≈¡¨≥È°Ïd£∫°ÏaπÃ∂®÷–º‰≥ÈΩ±")) {
				Other.data.set("Info."+name+".ninetype", "normal");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
		  		p.sendMessage("°Ïa≥…π¶…Ë÷√");
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°ÏeÀÊª˙Œª÷√≥ÈΩ±")) {
				Other.data.set("Info."+name+".type", "random");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
		  		p.sendMessage("°Ïa≥…π¶…Ë÷√");
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ïcæ≈¡¨≥È°Ïd£∫°ÏeÀÊª˙Œª÷√≥ÈΩ±")) {
				Other.data.set("Info."+name+".ninetype", "random");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
		  		p.sendMessage("°Ïa≥…π¶…Ë÷√");
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ïb∑∂ŒßŒª÷√ƒ⁄≥ÈΩ±")) {
				Other.data.set("Info."+name+".type", "order");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
		  		p.sendMessage("°Ïa≥…π¶…Ë÷√");
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ïcæ≈¡¨≥È°Ïd£∫°Ïb∑∂ŒßŒª÷√ƒ⁄≥ÈΩ±")) {
				Other.data.set("Info."+name+".ninetype", "order");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
		  		p.sendMessage("°Ïa≥…π¶…Ë÷√");
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ïb”–ŒÔ∆∑µƒÀÊª˙≥ÈΩ±")) {
				Other.data.set("Info."+name+".type", "embellishment");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
		  		p.sendMessage("°Ïa≥…π¶…Ë÷√");
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ïcæ≈¡¨≥È°Ïd£∫°Ï6øÏ¿÷æÿ–Œ≥ÈΩ±")) {
				Other.data.set("Info."+name+".ninetype", "gradient");
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
		  		p.sendMessage("°Ïa≥…π¶…Ë÷√");
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ïa∑µªÿ…Ë÷√¡–±Ì")) {
				p.closeInventory();
				Gui.choose(p, name);
				return;
			}
	    	return;
	    }
	    if(player.getClickedInventory().getTitle().startsWith("°Ï3œÎ∂‘")) {
	    	player.setCancelled(true);
			String title = player.getClickedInventory().getTitle();
			String name = ChatColor.stripColor(title.replace("°Ï3œÎ∂‘", "").replace("°Ï3Ω¯–– ≤√¥≤Ÿ◊˜£ø", ""));
			if(player.getCurrentItem() == null || player.getCurrentItem().getType() == Material.AIR) {
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ï5–ﬁ∏ƒΩ±≥ÿΩ±¿¯")) {
				Gui.setcrate(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ï6…Ë÷√—’…´")) {
				Gui.color(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().startsWith("°Ïa…Ë÷√")) {
				Gui.way(p, name);
				return;
			}
			if(player.getCurrentItem().getItemMeta().getDisplayName().equals("°Ïc…æ≥˝’‚∏ˆœ‰◊”")) {
				Other.data.set("Info."+name, null);
		  		Other.data.set("backup."+name, null);
		  		try {
		  			Other.data.save(file1);
		  		} catch (IOException e) {
		  			e.printStackTrace();
	        	}
				p.closeInventory();
		  		for(Player players:Bukkit.getOnlinePlayers()) {
		  			if(players.getOpenInventory().getTitle().startsWith("°Ïa≥ÈΩ±œ‰°Ï2¡–±Ì°Ï5£∫°Ïdµ⁄°Ïe")) {
		  				String titles = players.getOpenInventory().getTitle();
		  				int type = Integer.parseInt(titles.replace("°Ïa≥ÈΩ±œ‰°Ï2¡–±Ì°Ï5£∫°Ïdµ⁄°Ïe", "").replace("°Ïd“≥", ""));
		  				players.closeInventory();
		  				Gui.cratelist(players, type);
		  			}else if(players.getOpenInventory().getTitle().startsWith("°Ï2≥ÈΩ±œ‰"+Other.data.getString("Info."+name+".color")+name)) {
		  					players.closeInventory();
		  					players.sendMessage("°Ïa’‚∏ˆ≥ÈΩ±œ‰±ª°Ïc"+p.getName()+"°Ïa…æ≥˝£°");
		  			}else if(players.getOpenInventory().getTitle().equals(title)) {
	  					players.closeInventory();
	  					players.sendMessage("°Ïa’‚∏ˆ≥ÈΩ±œ‰±ª°Ïc"+p.getName()+"°Ïa…æ≥˝£°");
		  			}else if(players.getOpenInventory().getTitle().startsWith(ChatColor.stripColor("…Ë÷√"+Other.data.getString("Info."+name+".color")+name+"œ‘ æµƒ—’…´"))) {
	  					players.closeInventory();
	  					players.sendMessage("°Ïa’‚∏ˆ≥ÈΩ±œ‰±ª°Ïc"+p.getName()+"°Ïa…æ≥˝£°");
		  			}else if(player.getClickedInventory().getTitle().startsWith(ChatColor.stripColor("°Ïd…Ë÷√≥ÈΩ±œ‰"+Other.data.getString("Info."+name+".color")+name+"µƒø™œ‰∑Ω Ω"))) {
	  					players.closeInventory();
	  					players.sendMessage("°Ïa’‚∏ˆ≥ÈΩ±œ‰±ª°Ïc"+p.getName()+"°Ïa…æ≥˝£°");
		  			}
		  		}
				p.sendMessage("°Ïc…æ≥˝°Ïa"+name+"°Ïc≥…π¶");
				return;
			}
	    }
	}

	@EventHandler
public void Close(InventoryCloseEvent event) {
    if(event.getInventory().getTitle().startsWith("°Ï2≥ÈΩ±œ‰")) {
    	String title = ChatColor.stripColor(event.getInventory().getTitle().replace("°Ï2≥ÈΩ±œ‰", "").replace("°Ï2…Ë÷√", ""));
    	ArrayList<String> data = new ArrayList<String>();
  		int a=0;
  		while(a<54) {
  			String item = null;
  			if(event.getInventory().getItem(a)==null||event.getInventory().getItem(a).getType()==Material.AIR)
  			item = "null";
  			else
  			item = GetItemData(event.getInventory().getItem(a));
  			data.add(a+":"+item);
  			a++;
  		}
  		a=0;
  		List<String> exist = Other.data.getStringList("Info."+title+".data");
  		if(exist.size()==0) {
  			Other.data.set("Info."+title+".color", "°Ïf");
  			Other.data.set("Info."+title+".animation", true);
  			Other.data.set("Info."+title+".nineanimation", true);
  			Other.data.set("Info."+title+".announcement", "Œﬁ");
  			Other.data.set("Info."+title+".nine", "Œﬁ");
  			Other.data.set("Info."+title+".number", -1);
  			Other.data.set("Info."+title+".cd", -1);
  			Other.data.set("Info."+title+".ninenumber", -1);
  			Other.data.set("Info."+title+".ninecd", -1);
  			Other.data.set("Info."+title+".type", "normal");
  			Other.data.set("Info."+title+".ninetype", "normal");
  			Other.data.set("Info."+title+".clear", false);
  			Other.data.set("Info."+title+".info", false);
  			Other.data.set("Info."+title+".nineinfo", false);
  			Other.data.set("Info."+title+".backup", false);
  			crate = null;
  		}
  		Other.data.set("backup."+title, data);
  		Other.data.set("Info."+title+".data", data);
  		try {
  			Other.data.save(file1);
  		} catch (IOException e) {
  			e.printStackTrace();
    	}
  		Player player = (Player) event.getPlayer();
  		player.sendMessage("°Ïa±£¥Ê≥…π¶");
  		for(Player players:Bukkit.getOnlinePlayers()) {
  			if(players.getOpenInventory().getTitle().startsWith("°Ïa≥ÈΩ±œ‰°Ï2¡–±Ì°Ï5£∫°Ïdµ⁄°Ïe")) {
  				String titles = players.getOpenInventory().getTitle();
  				int type = Integer.parseInt(titles.replace("°Ïa≥ÈΩ±œ‰°Ï2¡–±Ì°Ï5£∫°Ïdµ⁄°Ïe", "").replace("°Ïd“≥", ""));
  				players.closeInventory();
  				Gui.cratelist(players, type);
			}
		}
    	return;
    }   
}

//	ItemStack◊™String
	public String GetItemData(ItemStack item) {
		String a;
		try {
		    a = new StreamSerializer().serializeItemStack(item);
		} catch (Exception e) {
		    a = null;
		}
		return a;
	}
//	String◊™ItemStack
	public ItemStack GetItemStack(String data) {
		try {
			return new StreamSerializer().deserializeItemStack(data);
		} catch (Exception e) {
			e.printStackTrace();
		}
		return null;
	}
}